var muniButlerApp=angular.module("muniButler",["ngMap","ngResource","ngRoute","ngMaterial"]).config(function($routeProvider,$httpProvider){$httpProvider.defaults.withCredentials=!0,$routeProvider.when("/",{templateUrl:"views/home.html",controller:"HomeController"}).when("/routes",{templateUrl:"views/routes.html",controller:"RoutesController"}).when("/login",{templateUrl:"views/login.html",controller:""}).otherwise({redirectTo:"/"})});muniButlerApp.factory("Auth",function($http){var check=function(){return $http.get("/api/user",{withCredentials:!0})},update=function(user){return console.log("user: ",user),$http.put("/api/user",user,{withCredentials:!0})},logout=function(){return $http.get("/api/logout",{withCredentials:!0})};return{check:check,logout:logout,update:update}}),muniButlerApp.factory("User",function(Auth){var user={};return user.routes=[],user.trip={from:"",to:""},user.addRoute=function(obj){var route={id:user.routes.length,from:obj.from,to:obj.to,route:obj.route};return user.routes.push(route),console.log("route",Auth),user.id&&(console.log("adding route"),Auth.update(user)),route},user.removeRoute=function(id){var removed=user.routes.splice(id,1);return user.id&&Auth.update(user),removed},user}),muniButlerApp.factory("Autocomplete",function(){var initialize=function(scope){var from=new google.maps.places.Autocomplete(document.getElementsByClassName("autocomplete")[0]),to=new google.maps.places.Autocomplete(document.getElementsByClassName("autocomplete")[1]);google.maps.event.addListener(from,"place_changed",function(){scope.user.from=from.getPlace().formatted_address}),google.maps.event.addListener(to,"place_changed",function(){scope.user.to=to.getPlace().formatted_address})};return{initialize:initialize}}),muniButlerApp.factory("GoogleMaps",function($q){var googleMaps={};return googleMaps.getRouteOptions=function(from,to){return console.log(from,to),$q(function(resolve,reject){console.log(from,to);var directions=new google.maps.DirectionsService,directionsRequest={origin:from,destination:to,travelMode:google.maps.TravelMode.TRANSIT,transitOptions:{modes:[google.maps.TransitMode.BUS]},unitSystem:google.maps.UnitSystem.IMPERIAL,durationInTraffic:!0,provideRouteAlternatives:!0,avoidHighways:!1,avoidTolls:!1},directionsDisplay=new google.maps.DirectionsRenderer,mapOptions={zoom:18,center:new google.maps.LatLng(37.783724,-122.408978)},map=new google.maps.Map(document.getElementById("routes-map"),mapOptions);directionsDisplay.setMap(map),directions.route(directionsRequest,function(results,status){if("OK"===!status)throw status;directionsDisplay.setDirections(results);var routes=[];angular.forEach(results.routes,function(route,index,obj){var routeObj={};routeObj.lines=[],routeObj.duration=route.legs[0].duration.text;var steps=route.legs[0].steps;for(var key in steps)if("TRANSIT"===steps[key].travel_mode){var busNumber=route.legs[0].steps[key].transit.line.short_name,stopName=route.legs[0].steps[key].transit.departure_stop.name,arrivalLocation=route.legs[0].steps[key].transit.arrival_stop.location.F,departureLocation=route.legs[0].steps[key].transit.departure_stop.location.F,direction="";direction=arrivalLocation>departureLocation?"Inbound":"Outbound",busNumber&&routeObj.lines.push([busNumber,stopName,direction])}routeObj.lines.length>0&&routes.push(routeObj)}),routes.length>0?resolve(routes):reject("No options found")})})},googleMaps}),muniButlerApp.factory("Bus",function($http){var getBusArrivalTimes=function(busNumber,stopName,direction){return $http.get("/api/bus",{params:{busNumber:busNumber,stopName:stopName,direction:direction}})},getBusesArrivalTimes=function(routes){angular.forEach(routes,function(route,i,obj){var busNumber=route.lines[0][0],stopName=route.lines[0][1],busDirection=route.lines[0][2];getBusArrivalTimes(busNumber,stopName,busDirection).then(function(busInfos){var busTimes=traverseXML(busInfos.data.xml,busInfos.data.busNumber,busInfos.data.direction,busInfos.data.stopName);route.arrivalTimes=busTimes})["catch"](function(data,status,headers,config){throw"ERROR: "+data})})},traverseXML=function(xml,busNumber,direction,stopName){var parser,xmlDoc,times=[];window.DOMParser?(parser=new DOMParser,xmlDoc=parser.parseFromString(xml,"text/xml")):(xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async="false",xmlDoc.loadXML(xml));var crawl=function(element){if("Route"===element.tagName&&element.getAttribute("Code")===busNumber){var routeDirectionList=element.children[0],routeDirection=routeDirectionList.children[0];if(routeDirection.getAttribute("Code")===direction){var stopList=routeDirection.children[0],stop=stopList.children[0];if(stop.getAttribute("name")===stopName)for(var departureList=stop.children[0],j=0;j<departureList.children.length;j++)times.push(departureList.children[j].innerHTML)}}if(element.children.length>0)for(var i=0;i<element.children.length;i++)crawl(element.children[i])};return crawl(xmlDoc.children[0].children[0]),times};return{getBusArrivalTimes:getBusArrivalTimes,getBusesArrivalTimes:getBusesArrivalTimes,traverseXML:traverseXML}}),muniButlerApp.controller("LogController",function($scope,Auth,User){$scope.loggedin=!1,$scope.options=[],$scope.logincheck=function(){Auth.check().then(function(resp){$scope.loggedin=!0,User.displayName=resp.data.displayName,User.id=resp.data.id,User.routes=resp.data.routes})["catch"](function(err){$scope.options=err.data.authMethods})},$scope.logout=function(){Auth.logout().then(function(resp){return $scope.loggedin=!1,$scope.logincheck()})["catch"](function(err){console.log(err)})},$scope.logincheck()}),muniButlerApp.controller("HomeController",function($scope,$location,User,Autocomplete,GoogleMaps){function success(position){var pos,geocoder=new google.maps.Geocoder,latlng=new google.maps.LatLng(position.coords.latitude,position.coords.longitude);geocoder.geocode({location:latlng},function(results,status){status==google.maps.GeocoderStatus.OK&&(pos=results[0].formatted_address,$scope.user.from=pos,$scope.$apply())}),$scope.setMap(latlng)}function error(){console.log("Geolocation failed"),$scope.setMap(new google.maps.LatLng(37.7837235,-122.4089778))}$scope.routes=User.routes,$scope.addnewroute=!1,$scope.msg="Add new route!",$scope.msgChange=function(){$scope.addnewroute?$scope.msg="Cancel":$scope.msg="Add new route!"},$scope.user={from:"Finding current location..."},$scope.enter=!1,$scope.submit=function(validation){validation&&(User.trip={to:$scope.user.to,from:$scope.user.from},$location.path("/routes"))},$scope.setMap=function(location){var directionsDisplay=new google.maps.DirectionsRenderer,mapOptions={zoom:18,center:location},map=new google.maps.Map(document.getElementById("routes-map"),mapOptions);directionsDisplay.setMap(map)},Autocomplete.initialize($scope),navigator.geolocation&&navigator.geolocation.getCurrentPosition(success,error)}),muniButlerApp.controller("RoutesController",function($scope,$location,$timeout,User,GoogleMaps,Bus){$scope.model={trip:User.trip,going:!0,returning:!1,routeHeading:"Departure Route",routeOptions:[],route:{from:User.trip.from,to:User.trip.to,route:""}},$scope.model.selectRoute=function(route){console.log(route);var busNumber=route.lines[0][0],stopName=route.lines[0][1],duration=route.duration,arrivalTimes=route.arrivalTimes;$scope.model.going&&!$scope.model.returning?($scope.model.routeHeading="Departure Route",$scope.model.route.route=[busNumber,stopName,duration,arrivalTimes],User.addRoute($scope.model.route),$scope.model.routeHeading="Return Route",$scope.model.going=!1,$scope.model.returning=!0,GoogleMaps.getRouteOptions(User.trip.to,User.trip.from).then(function(routes){$scope.model.routeOptions=routes,Bus.getBusesArrivalTimes(routes)},function(error){console.log("Failed: "+error)})):!$scope.model.going&&$scope.model.returning&&($scope.model.route.route=[busNumber,stopName,duration,arrivalTimes],User.addRoute($scope.model.route),$scope.model.returning=!1,$scope.model.going=!0,$location.path("/"))},$scope.model.route.to&&$scope.model.route.from||$location.path("/"),GoogleMaps.getRouteOptions(User.trip.from,User.trip.to).then(function(routes){$scope.model.routeOptions=routes,Bus.getBusesArrivalTimes(routes)},function(error){console.log("Failed: "+error)})});